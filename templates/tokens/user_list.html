{% extends 'dashboard.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Administración de Tokens</h2>
    <table id="usersTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Último Login</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.get_full_name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.last_login|date:"Y-m-d H:i" }}</td>
                <td>
                    <button class="btn btn-sm btn-primary generate-token" data-userid="{{ user.id }}">
                        Generar Token
                    </button>
                    <div id="token-{{ user.id }}" class="mt-2" style="display:none;">
                        <input type="text" class="form-control token-value" readonly>
                        <button class="btn btn-sm btn-secondary copy-token mt-1" data-target="token-{{ user.id }}">
                            Copiar
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block javascript %}
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
    $(document).ready(function() {
        $('#usersTable').DataTable({
            responsive: true,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            }
        });

        $('.generate-token').click(function() {
            const userId = $(this).data('userid');
            const tokenContainer = $(`#token-${userId}`);
            
            $.ajax({
                url: '/api/generate-token/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Authorization': 'Token ' + '{{ request.user.auth_token.key }}'  // Si usas autenticación por token
                },
                success: function(response) {
                    tokenContainer.find('.token-value').val(response.token);
                    tokenContainer.show();
                    toastr.success('Token generado con éxito');
                },
                error: function(xhr) {
                    toastr.error('Error al generar token: ' + xhr.responseText);
                }
            });
        });

        $('.copy-token').click(function() {
            const target = $(this).data('target');
            const tokenValue = $(`#${target} .token-value`).val();
            
            navigator.clipboard.writeText(tokenValue).then(function() {
                toastr.success('Token copiado al portapapeles');
            }, function() {
                toastr.error('Error al copiar el token');
            });
        });
    });
</script>
{% endblock %}